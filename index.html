<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Super Breakout LIVE</title>

  <style>
    :root{
      --bg:#0b0e11;
      --panel:#0e1218;
      --panel2:#0b0e11;
      --text:#cfd3dc;
      --muted:#8b93a1;
      --line:#1e2329;
      --ok:#16c784;
      --bad:#ea3943;
      --warn:#f0b90b;
      --chip:#121825;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: Arial, sans-serif;
    }

    #app{
      display:flex;
      flex-direction:column;
      height:100vh;
      overflow:hidden;
    }

    #chart-wrapper{
      position:relative;
      flex:1;
      min-height:55vh;
      border-bottom:1px solid var(--line);
      background:#000;
    }
    #chart{
      width:100%;
      height:100%;
    }

    /* Overlay layers */
    .layer{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    #vacuum-layer{ z-index:5; }
    #compress-layer{ z-index:6; }
    #aggression-layer{ z-index:7; }

    /* Vacuum */
    .vacuum-zone{
      position:absolute;
      left:5%;
      width:90%;
      background: rgba(0, 255, 150, 0.12);
      border: 2px solid rgba(0, 255, 150, 0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:32px;
      font-weight:bold;
      letter-spacing:4px;
      color: rgba(0, 255, 150, 0.35);
    }

    /* Compress */
    .compress-zone{
      position:absolute;
      left:15%;
      width:70%;
      background: rgba(255, 180, 0, 0.18);
      border: 2px solid rgba(255, 180, 0, 0.70);
      border-radius: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:bold;
      letter-spacing:3px;
      color: rgba(255, 200, 80, 0.60);
    }

    /* Aggression */
    .aggr-zone{
      position:absolute;
      left:8%;
      width:84%;
      height:54px;
      border-radius:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:bold;
      letter-spacing:2px;
      opacity:.85;
    }
    .aggr-buy{
      background: rgba(22,199,132,.10);
      border: 2px solid rgba(22,199,132,.55);
      color: rgba(22,199,132,.85);
    }
    .aggr-sell{
      background: rgba(234,57,67,.10);
      border: 2px solid rgba(234,57,67,.55);
      color: rgba(234,57,67,.85);
    }

    /* Bottom panel */
    #panel{
      background: var(--panel2);
      padding: 14px;
      overflow:auto;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }

    .grid{
      display:grid;
      gap:12px;
    }
    @media (min-width: 900px){
      #app{ flex-direction:row; }
      #chart-wrapper{ flex:3.2; min-height:100vh; border-bottom:none; border-right:1px solid var(--line);}
      #panel{ flex:1.3; height:100vh; overflow:auto;}
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .col{ flex:1; min-width: 170px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select, input{
      width:100%;
      background: var(--chip);
      color: var(--text);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
    }
    input::placeholder{ color: rgba(200,210,220,.35); }

    .mini{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .kpi{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      border-top:1px solid rgba(255,255,255,.07);
      padding-top:10px;
      margin-top:10px;
    }
    .status-ok{ color: var(--ok); font-weight:bold; }
    .status-bad{ color: var(--bad); font-weight:bold; }
    .status-warn{ color: var(--warn); font-weight:bold; }

    .divider{ height:1px; background:rgba(255,255,255,.08); margin:12px 0; }

    .checkrow{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }
    .check{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      user-select:none;
    }
    .check input{ width:auto; }

    .slider{
      display:flex; gap:10px; align-items:center;
    }
    .slider input[type="range"]{ width:100%; }

    /* TOP-10 list */
    .top10{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .topItem{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .topItem:hover{ background: rgba(255,255,255,.05); }
    .sym{ font-weight:bold; letter-spacing:.5px; }
    .score{
      font-variant-numeric: tabular-nums;
      font-size:12px;
      color: rgba(255,255,255,.75);
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.80);
    }

    /* Fallback message */
    #fallback{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      z-index:30;
      display:none;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color: #ff6b6b;
      padding:10px 12px;
      border-radius: 14px;
      font-size:14px;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="chart-wrapper">
      <div id="fallback">No chart available</div>
      <div id="chart"></div>

      <!-- overlays -->
      <div id="vacuum-layer" class="layer"></div>
      <div id="compress-layer" class="layer"></div>
      <div id="aggression-layer" class="layer"></div>
    </div>

    <div id="panel">
      <div class="grid">

        <!-- Instruments -->
        <div class="card">
          <div class="row">
            <div class="col">
              <label>Monēta</label>
              <select id="symbolSelect"></select>
            </div>
            <div class="col">
              <label>TF</label>
              <select id="tfSelect">
                <option value="1">1m</option>
                <option value="5">5m</option>
                <option value="15" selected>15m</option>
                <option value="60">1h</option>
                <option value="240">4h</option>
                <option value="D">1D</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="col">
              <label>Meklēt (piem. SOL, ETH...)</label>
              <input id="searchInput" placeholder="Meklēt..." />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Uzraudzība (ieraksti simbolu un Enter)</label>
              <input id="watchInput" placeholder="piem. SOLUSDT un Enter" />
            </div>
          </div>

          <div class="mini" style="margin-top:10px;">
            Šobrīd: <b>forma/karkass</b> + <b>reāla aggression plūsma (TOP-100)</b> + <b>TOP-10</b> + <b>auto-rotācija</b>.
          </div>
        </div>

        <!-- Methodik + Status -->
        <div class="card">
          <div style="font-size:18px; font-weight:bold; margin-bottom:8px;">Metodikas</div>
          <div class="mini" id="meta">
            Savienojums: <span id="conn" class="status-warn">CONNECTING</span><br>
            Instruments: <b id="metaSym">BTCUSDT</b><br>
            Timeframe: <b id="metaTf">15m</b><br>
            Cena: <b id="metaPrice">-</b><br>
            Latency: <b id="metaLat">-</b>
          </div>
          <div class="kpi">
            <div>Chart mode: <b id="chartMode" class="status-ok">TRADINGVIEW</b></div>
            <div class="badge" id="universeBadge">Universe: -</div>
          </div>
        </div>

        <!-- Controls -->
        <div class="card">
          <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">Kontrole</div>

          <div class="checkrow">
            <label class="check"><input type="checkbox" id="toggleVacuum" checked /> Vacuum</label>
            <label class="check"><input type="checkbox" id="toggleCompress" checked /> Compress</label>
            <label class="check"><input type="checkbox" id="toggleAggression" checked /> Aggression</label>
          </div>

          <div class="divider"></div>

          <div style="font-size:16px; font-weight:bold; margin-bottom:8px;">Kalibrācija</div>

          <label>Vacuum pozīcija (<span id="vacPosVal">35</span>%)</label>
          <div class="slider">
            <input type="range" id="vacPos" min="0" max="100" value="35" />
          </div>

          <label style="margin-top:10px;">Vacuum augstums (<span id="vacHVal">18</span>%)</label>
          <div class="slider">
            <input type="range" id="vacH" min="5" max="50" value="18" />
          </div>

          <label style="margin-top:10px;">Compress pozīcija (<span id="cmpPosVal">55</span>%)</label>
          <div class="slider">
            <input type="range" id="cmpPos" min="0" max="100" value="55" />
          </div>

          <label style="margin-top:10px;">Compress biezums (<span id="cmpHVal">48</span>px)</label>
          <div class="slider">
            <input type="range" id="cmpH" min="20" max="140" value="48" />
          </div>
        </div>

        <!-- TOP-10 -->
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div style="font-size:18px; font-weight:bold;">TOP-10 (aggression)</div>
            <span class="badge" id="topBadge">update: -</span>
          </div>

          <div class="mini" style="margin-top:8px;">
            Klikšķini uz monētas → grafiks pārslēdzas. Top-10 tiek rēķināts no reālajiem aggTrade.
          </div>

          <div class="divider"></div>

          <div class="row">
            <label class="check" style="flex:1;">
              <input type="checkbox" id="autoRotate" checked />
              Auto-rotācija pa TOP-10
            </label>
            <div style="flex:1; min-width:140px;">
              <label>Intervāls (<span id="rotVal">8</span>s)</label>
              <input type="range" id="rotSec" min="3" max="30" value="8" />
            </div>
          </div>

          <div class="top10" id="top10"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <script>
    /**********************************************************************
     *  0) Helpers
     **********************************************************************/
    const $ = (id) => document.getElementById(id);

    const state = {
      symbol: "BTCUSDT",
      tvSymbol: "BINANCE:BTCUSDT",
      tf: "15",
      connected: false,

      // Universe + stream
      universe: [],          // list of USDT perp symbols (e.g., BTCUSDT)
      topUniverse: [],       // top N by quoteVolume (performance)
      ws: null,
      lastMsgTs: 0,

      // Aggression scoring
      scores: new Map(),     // sym -> { buy, sell, ema, lastPx, lastTs }
      top10: [],

      // UI toggles
      showVacuum: true,
      showCompress: true,
      showAggression: true,

      // auto rotate
      rotateEnabled: true,
      rotateSec: 8,
      rotateTimer: null,
      rotateIndex: 0,

      // manual watchlist
      watch: new Set()
    };

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function now(){ return Date.now(); }
    function fmt(n){
      if (n === null || n === undefined) return "-";
      const x = Number(n);
      if (!isFinite(x)) return "-";
      if (x >= 1000) return x.toLocaleString(undefined, { maximumFractionDigits: 2 });
      return x.toLocaleString(undefined, { maximumFractionDigits: 6 });
    }

    /**********************************************************************
     *  1) Overlays (karkass)
     **********************************************************************/
    const vacuumLayer = $("vacuum-layer");
    const compressLayer = $("compress-layer");
    const aggrLayer = $("aggression-layer");

    const vacuumBox = document.createElement("div");
    vacuumBox.className = "vacuum-zone";
    vacuumBox.innerText = "VACUUM";
    vacuumLayer.appendChild(vacuumBox);

    const compressBox = document.createElement("div");
    compressBox.className = "compress-zone";
    compressBox.innerText = "COMPRESS";
    compressLayer.appendChild(compressBox);

    const sellAggr = document.createElement("div");
    sellAggr.className = "aggr-zone aggr-sell";
    sellAggr.innerText = "SELL AGGRESSION";
    aggrLayer.appendChild(sellAggr);

    const buyAggr = document.createElement("div");
    buyAggr.className = "aggr-zone aggr-buy";
    buyAggr.innerText = "BUY AGGRESSION";
    aggrLayer.appendChild(buyAggr);

    function layoutOverlays(){
      // sliders -> vacuum
      const vacPos = Number($("vacPos").value);
      const vacH = Number($("vacH").value);
      $("vacPosVal").innerText = vacPos;
      $("vacHVal").innerText = vacH;

      vacuumBox.style.top = vacPos + "%";
      vacuumBox.style.height = vacH + "%";

      // compress
      const cmpPos = Number($("cmpPos").value);
      const cmpH = Number($("cmpH").value);
      $("cmpPosVal").innerText = cmpPos;
      $("cmpHVal").innerText = cmpH;

      compressBox.style.top = cmpPos + "%";
      compressBox.style.height = cmpH + "px";

      // aggression fixed positions (can be algorithmic later)
      sellAggr.style.top = "3%";
      buyAggr.style.bottom = "6%";

      // visibility
      vacuumLayer.style.display = state.showVacuum ? "block" : "none";
      compressLayer.style.display = state.showCompress ? "block" : "none";
      aggrLayer.style.display = state.showAggression ? "block" : "none";
    }

    ["vacPos","vacH","cmpPos","cmpH"].forEach(id => $(id).addEventListener("input", layoutOverlays));

    $("toggleVacuum").addEventListener("change", (e) => {
      state.showVacuum = e.target.checked;
      layoutOverlays();
    });
    $("toggleCompress").addEventListener("change", (e) => {
      state.showCompress = e.target.checked;
      layoutOverlays();
    });
    $("toggleAggression").addEventListener("change", (e) => {
      state.showAggression = e.target.checked;
      layoutOverlays();
    });

    layoutOverlays();

    /**********************************************************************
     *  2) TradingView widget
     **********************************************************************/
    let tvWidget = null;

    function setFallback(on){
      $("fallback").style.display = on ? "block" : "none";
      $("chartMode").innerText = on ? "NO CHART" : "TRADINGVIEW";
      $("chartMode").className = on ? "status-bad" : "status-ok";
    }

    function initTradingView(){
      try{
        setFallback(false);
        tvWidget = new TradingView.widget({
          container_id: "chart",
          autosize: true,
          symbol: state.tvSymbol,
          interval: state.tf,
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          hide_top_toolbar: false,
          hide_legend: true,
          allow_symbol_change: false,
          save_image: false
        });
      }catch(err){
        console.error("TradingView init error:", err);
        setFallback(true);
      }
    }

    function changeChartSymbol(sym){
      state.symbol = sym;
      state.tvSymbol = "BINANCE:" + sym;

      $("metaSym").innerText = sym;

      // TradingView supports setSymbol after ready; on mobile some cases are flaky.
      // Robust approach: rebuild widget container.
      const chartEl = $("chart");
      chartEl.innerHTML = "";
      tvWidget = null;
      initTradingView();
    }

    function changeTimeframe(tf){
      state.tf = tf;
      $("metaTf").innerText = (tf === "D") ? "1D" : (tf + (tf === "60" ? "m (1h)" : "m"));
      // rebuild widget for reliability
      changeChartSymbol(state.symbol);
    }

    $("tfSelect").addEventListener("change", (e) => changeTimeframe(e.target.value));

    /**********************************************************************
     *  3) Universe load (Binance Futures USDT perpetual) + top volume selection
     **********************************************************************/
    async function fetchJSON(url){
      const t0 = now();
      const res = await fetch(url, { cache: "no-store" });
      const data = await res.json();
      const t1 = now();
      return { data, ms: (t1 - t0) };
    }

    async function loadUniverse(){
      // All USDT perpetual symbols
      const ex = await fetchJSON("https://fapi.binance.com/fapi/v1/exchangeInfo");
      const symbols = (ex.data.symbols || [])
        .filter(s => s.contractType === "PERPETUAL" && s.quoteAsset === "USDT" && s.status === "TRADING")
        .map(s => s.symbol);

      state.universe = symbols;

      // 24h ticker for quoteVolume (performance: scan top 100)
      const t24 = await fetchJSON("https://fapi.binance.com/fapi/v1/ticker/24hr");
      const volMap = new Map((t24.data || []).map(x => [x.symbol, Number(x.quoteVolume || 0)]));

      const ranked = symbols
        .map(sym => ({ sym, vol: volMap.get(sym) || 0 }))
        .sort((a,b) => b.vol - a.vol);

      // Performance setting: take top 100 + watchlist extras
      const TOP_N = 100;
      state.topUniverse = ranked.slice(0, TOP_N).map(x => x.sym);

      $("universeBadge").innerText = "Universe: " + state.topUniverse.length + "/" + state.universe.length;

      // Build select dropdown (full universe in select; top N for data stream)
      fillSymbolSelect(state.universe);

      // Default symbol presence check
      if (!state.universe.includes(state.symbol)) state.symbol = state.universe[0] || "BTCUSDT";
      $("symbolSelect").value = state.symbol;
      $("metaSym").innerText = state.symbol;

      return true;
    }

    function fillSymbolSelect(list){
      const sel = $("symbolSelect");
      sel.innerHTML = "";
      list.forEach(sym => {
        const opt = document.createElement("option");
        opt.value = sym;
        opt.textContent = sym;
        sel.appendChild(opt);
      });
    }

    $("symbolSelect").addEventListener("change", (e) => {
      const sym = e.target.value;
      changeChartSymbol(sym);
    });

    $("searchInput").addEventListener("input", (e) => {
      const q = e.target.value.trim().toUpperCase();
      const filtered = q ? state.universe.filter(s => s.includes(q)) : state.universe;
      fillSymbolSelect(filtered);
      // keep selection if possible
      if (filtered.includes(state.symbol)) $("symbolSelect").value = state.symbol;
    });

    $("watchInput").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const sym = e.target.value.trim().toUpperCase();
      e.target.value = "";
      if (!sym) return;

      // accept with or without USDT suffix
      let normalized = sym.endsWith("USDT") ? sym : (sym + "USDT");
      if (!state.universe.includes(normalized)){
        alert("Nav atrasts Futures USDT perp: " + normalized);
        return;
      }
      state.watch.add(normalized);
      // ensure watched symbol is streamed (add to topUniverse if missing)
      if (!state.topUniverse.includes(normalized)){
        state.topUniverse.unshift(normalized);
        state.topUniverse = state.topUniverse.slice(0, 120); // cap
        restartAggressionStream();
        $("universeBadge").innerText = "Universe: " + state.topUniverse.length + "/" + state.universe.length;
      }
      changeChartSymbol(normalized);
    });

    /**********************************************************************
     *  4) Aggression stream (Binance Futures aggTrade)
     *     - score = EMA of (buyQty - sellQty) magnitude (dominance)
     *     - top10 from absolute EMA (most active aggression)
     **********************************************************************/
    function resetScores(){
      state.scores.clear();
    }

    function ensureScore(sym){
      if (!state.scores.has(sym)){
        state.scores.set(sym, { buy:0, sell:0, ema:0, lastPx:null, lastTs:0 });
      }
      return state.scores.get(sym);
    }

    function updateScore(sym, qty, isBuyerMaker, price, ts){
      // In Binance aggTrade:
      // m = true means buyer is the market maker -> trade was SELL aggressor (taker sell)
      // m = false -> BUY aggressor (taker buy)
      const s = ensureScore(sym);

      const q = Number(qty) || 0;
      if (isBuyerMaker) s.sell += q; else s.buy += q;

      // short-window EMA of signed imbalance, then take abs for ranking
      const signed = (isBuyerMaker ? -q : q);
      const alpha = 0.06; // smoothing (tunable)
      s.ema = (1 - alpha) * s.ema + alpha * signed;

      s.lastPx = Number(price) || s.lastPx;
      s.lastTs = ts || now();
    }

    function computeTop10(){
      const arr = [];
      for (const [sym, s] of state.scores.entries()){
        // use activity floor to avoid noise
        const act = s.buy + s.sell;
        if (act < 20) continue; // floor (tunable)
        arr.push({
          sym,
          score: Math.abs(s.ema),
          bias: (s.ema >= 0) ? "BUY" : "SELL",
          px: s.lastPx
        });
      }
      arr.sort((a,b) => b.score - a.score);
      state.top10 = arr.slice(0, 10);
      renderTop10();
    }

    function renderTop10(){
      const box = $("top10");
      box.innerHTML = "";

      const stamp = new Date().toLocaleTimeString();
      $("topBadge").innerText = "update: " + stamp;

      state.top10.forEach((x, idx) => {
        const row = document.createElement("div");
        row.className = "topItem";
        row.title = "Klikšķini → atvērt grafiku";

        const left = document.createElement("div");
        left.innerHTML = `<div class="sym">${idx+1}. ${x.sym}</div><div class="mini">${x.bias} · px: ${fmt(x.px)}</div>`;

        const right = document.createElement("div");
        right.innerHTML = `<div class="score">score: ${x.score.toFixed(4)}</div>`;

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener("click", () => {
          // when user clicks, pause rotation index to this symbol
          changeChartSymbol(x.sym);
          $("symbolSelect").value = x.sym;
          state.rotateIndex = idx;
        });

        box.appendChild(row);
      });

      // Update price display for current symbol (if we have it)
      const cur = state.scores.get(state.symbol);
      if (cur && cur.lastPx){
        $("metaPrice").innerText = fmt(cur.lastPx);
      }
    }

    function wsStreamsForUniverse(list){
      // multiplex stream names: <symbol>@aggTrade
      return list.map(sym => sym.toLowerCase() + "@aggTrade");
    }

    function startAggressionStream(){
      stopAggressionStream();
      resetScores();

      const streams = wsStreamsForUniverse(state.topUniverse);
      const url = "wss://fstream.binance.com/stream?streams=" + encodeURIComponent(streams.join("/"));

      const ws = new WebSocket(url);
      state.ws = ws;

      let pingTimer = null;

      ws.onopen = () => {
        state.connected = true;
        $("conn").innerText = "CONNECTED";
        $("conn").className = "status-ok";
        state.lastMsgTs = now();

        // periodic top10 calculation
        pingTimer = setInterval(() => {
          // disconnect detection
          const silence = now() - state.lastMsgTs;
          if (silence > 8000){
            $("conn").innerText = "RECONNECTING";
            $("conn").className = "status-warn";
          }
          computeTop10();
        }, 1000);
      };

      ws.onmessage = (evt) => {
        state.lastMsgTs = now();

        // latency approximation (client-side)
        $("metaLat").innerText = "≈ " + Math.max(0, now() - state.lastMsgTs) + "ms";

        let msg;
        try { msg = JSON.parse(evt.data); } catch { return; }
        if (!msg || !msg.data) return;

        const d = msg.data;
        // aggTrade fields: s symbol, p price, q qty, T trade time, m isBuyerMaker
        const sym = d.s;
        updateScore(sym, d.q, d.m, d.p, d.T);

        // update current symbol price fast
        if (sym === state.symbol){
          $("metaPrice").innerText = fmt(d.p);
        }
      };

      ws.onerror = (e) => {
        console.error("WS error", e);
      };

      ws.onclose = () => {
        state.connected = false;
        $("conn").innerText = "RECONNECTING";
        $("conn").className = "status-warn";
        if (pingTimer) clearInterval(pingTimer);

        // auto-reconnect
        setTimeout(() => startAggressionStream(), 1200);
      };
    }

    function stopAggressionStream(){
      if (state.ws){
        try{ state.ws.close(); }catch{}
        state.ws = null;
      }
    }

    function restartAggressionStream(){
      startAggressionStream();
    }

    /**********************************************************************
     *  5) Auto-rotation TOP-10
     **********************************************************************/
    function startRotation(){
      stopRotation();
      state.rotateTimer = setInterval(() => {
        if (!state.rotateEnabled) return;
        if (!state.top10 || state.top10.length === 0) return;

        state.rotateIndex = (state.rotateIndex + 1) % state.top10.length;
        const next = state.top10[state.rotateIndex];
        if (!next) return;

        changeChartSymbol(next.sym);
        $("symbolSelect").value = next.sym;
      }, state.rotateSec * 1000);
    }

    function stopRotation(){
      if (state.rotateTimer){
        clearInterval(state.rotateTimer);
        state.rotateTimer = null;
      }
    }

    $("autoRotate").addEventListener("change", (e) => {
      state.rotateEnabled = e.target.checked;
    });

    $("rotSec").addEventListener("input", (e) => {
      state.rotateSec = Number(e.target.value);
      $("rotVal").innerText = state.rotateSec;
      startRotation();
    });
    $("rotVal").innerText = $("rotSec").value;

    /**********************************************************************
     *  6) Boot
     **********************************************************************/
    (async function boot(){
      // initial meta
      $("metaSym").innerText = state.symbol;
      $("metaTf").innerText = "15m";

      // load markets
      try{
        await loadUniverse();
      }catch(err){
        console.error("Universe load failed:", err);
        $("conn").innerText = "NO DATA";
        $("conn").className = "status-bad";
      }

      // start chart
      initTradingView();

      // start data flow
      startAggressionStream();

      // start rotation
      state.rotateEnabled = $("autoRotate").checked;
      state.rotateSec = Number($("rotSec").value);
      startRotation();
    })();
  </script>
</body>
</html>
